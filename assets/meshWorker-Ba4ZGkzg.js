(function(){"use strict";self.onmessage=s=>{const t=s.data;if(!t||t.type!=="build")return;const{w:n,h:o,spacing:c,jitter:f,kNearest:x,maxDistFactor:a}=t,i=c,g=Math.ceil(n/i)+2,w=Math.ceil(o/i)+2,k=-i,X=-i,h=new Array(w*g);let E=0;for(let e=0;e<w;e++)for(let l=0;l<g;l++,E++){const d=k+l*i,p=X+e*i,r=(Math.random()*2-1)*f,u=(Math.random()*2-1)*f;h[E]={x:d+r,y:p+u}}const y=[],Y=i*a;for(let e=0;e<h.length;e++){const l=h[e],d=[];for(let r=0;r<h.length;r++){if(e===r)continue;const u=h[r],m=l.x-u.x,N=l.y-u.y,D=Math.hypot(m,N);D>0&&D<=Y&&d.push({j:r,d:D})}d.sort((r,u)=>r.d-u.d);let p=0;for(let r=0;r<d.length&&p<x;r++){const u=d[r].j,m=e<u?[e,u]:[u,e];C(y,m)||F(m,y,h)||(y.push(m),p++)}}const B=h.length,A=new Float32Array(B*2);for(let e=0;e<B;e++){const l=h[e];A[e*2]=l.x,A[e*2+1]=l.y}const b=new Uint32Array(y.length*2);for(let e=0;e<y.length;e++)b[e*2]=y[e][0],b[e*2+1]=y[e][1];self.postMessage({type:"mesh",nodes:A.buffer,edges:b.buffer,seq:t.seq??0},[A.buffer,b.buffer])};function C(s,[t,n]){for(let o=0;o<s.length;o++){const[c,f]=s[o];if(c===t&&f===n||c===n&&f===t)return!0}return!1}function F(s,t,n){const[o,c]=s,f=n[o],x=n[c];for(let a=0;a<t.length;a++){const[i,g]=t[a];if(o===i||o===g||c===i||c===g)continue;const w=n[i],k=n[g];if(I(f,x,w,k))return!0}return!1}function I(s,t,n,o){const c=M(s,t,n),f=M(s,t,o),x=M(n,o,s),a=M(n,o,t);return c===0&&j(s,n,t)||f===0&&j(s,o,t)||x===0&&j(n,s,o)||a===0&&j(n,t,o)?!0:(c>0&&f<0||c<0&&f>0)&&(x>0&&a<0||x<0&&a>0)}function M(s,t,n){return(t.y-s.y)*(n.x-t.x)-(t.x-s.x)*(n.y-t.y)}function j(s,t,n){return Math.min(s.x,n.x)<=t.x&&t.x<=Math.max(s.x,n.x)&&Math.min(s.y,n.y)<=t.y&&t.y<=Math.max(s.y,n.y)}})();
